(async()=>{window.cleanup=async()=>{old_v_page||(old_v_page=window.location.pathname),c(),i(),await r(),await l(),await h(),await w(),await p(),window.scrollTo({top:0,behavior:"smooth"})};const t=await import("./reference.js").then((t=>t.ref)),e=document.createRange(),a=document.body,n="Fragmenium",o=new Request("/fragment-version");if((await caches.keys()).includes(n)){const e=await caches.open(n),a=await e.match(o),c=!!a&&await a.text();if("dev"===t.version)console.log("what"),await caches.delete(n);else if(t.version!==c){await caches.delete(n);const e=await caches.open(n);await e.put(o,new Response(t.version,{headers:{"Content-Type":"text/plain; charset=utf-8"}}))}}else if("dev"!==t.version){const e=await caches.open(n);await e.put(o,new Response(t.version,{headers:{"Content-Type":"text/plain; charset=utf-8"}}))}function c(){if(!t?.css?.common)return;let e=new m(window.location.pathname).directory_path();""===e&&(e="/");const a=t.css.common[e];window.active_dir!==e&&(document.head.querySelectorAll('link[data-type="common"]').forEach((t=>t.remove())),window.active_dir=e,a&&a.forEach((t=>s(t,"common"))))}function i(){if(!t?.css?.specific)return;document.head.querySelectorAll('link[data-type="specific"]').forEach((t=>t.remove()));const e=t.css.specific[window.location.pathname];e&&e.forEach((t=>s(t,"specific")))}function s(t,a){document.head.appendChild(e.createContextualFragment(`<link data-type="${a}" rel="stylesheet" href="${t}">`))}async function r(a){if(t.unique){const a=window.location.pathname,n=await fetch(a);if(!n.ok){const e=t.error_page?t.error_page:"/404.html";return history.replaceState({},"",e),void r()}const o=await n.text(),c=await e.createContextualFragment(o),i=t.unique.map((async t=>{const e=document.querySelector(t),n=c.querySelector(t);await u(n),e?n?e.replaceWith(n):console.log(`"${t}" does not exist in ${a}`):console.log(`"${t}" does not exist in ${old_v_page}`)}));await Promise.all(i)}}async function l(){if(t.common){let n=new m(window.location.pathname).directory_path();""===n&&(n="/");const o=t.common.map((async t=>{let o;if(t.except&&(o=t.except[n]),o){if(window[t.selector]==n)return;window[t.selector]=n}else{if("default"==window[t.selector])return;window[t.selector]="default",o=t.default}const c=a.querySelector(t.selector);if(c)try{const a=await d(o),n=e.createContextualFragment(a).querySelector(t.selector);await u(n),c.replaceWith(n)}catch(e){console.error(`Error fetching or injecting ${t.path}:`,e)}else console.log(`"${t.selector}" does not exist on this page`)}));await Promise.all(o)}}async function w(){if(!t?.js?.common)return;f("#common_js");let e=new m(window.location.pathname).directory_path();""==e&&(e="/");t.js.common[e]&&await y(t.js.common[e],"common_js")}async function p(){if(!t?.js?.specific)return;f("#specific_js");const e=window.location.pathname,a=t.js.specific[e];a&&await y(a,"specific_js")}async function h(){t?.js?.every&&(f("#every_js"),await y(t.js.every,"every_js"))}async function u(a){if(!t.swap)return;const n=Object.entries(t.swap).map((async([t,n])=>{const o=a.querySelectorAll(t);for(const t of o)if(t){let a;window["swap_text_"+n]?a=window["swap_text_"+n]:(a=await d(n),window["swap_text_"+n]=a);const o=a.match(/\${(.*?)}/g);if(o)for(let e of o){const n=t.getAttribute(e.match(/\$\{([^}]+)\}/)?.[1])??"";a=a.replace(e,n)}const c=e.createContextualFragment(a);t.replaceWith(c)}}));await Promise.all(n)}async function d(e){const a=await caches.open(n),c=await a.match(o),i=!!c&&await c.text();if("dev"===t.version){const t=await fetch(e);return t.ok||console.warn(t.status),await t.text()}if(t.version===i){const t=await a.match(e);if(t)return await t.text();const n=await fetch(e);return n.ok||console.warn(n.status),await a.put(e,n.clone()),await n.text()}const s=await fetch(e);if(s.ok)return await a.put(e,s.clone()),await s.text();console.warn(s.status)}function f(t){document.querySelector(t)?.remove()}function m(t){this.path=t,this.extention=()=>this.path.split(".").pop(),this.file=()=>this.path.split("/").pop(),this.directory_path=()=>{const t=this.path.split("/");return t.pop(),t.join("/")},this.directorys=()=>{const t=this.path.split("/");return t.shift(),t.pop(),t}}async function y(t,e){const n=await Promise.all(t.map((async t=>`\n //start ${t}\n${await d(t)}\n//end ${t}\n`)));!function(t){const n=`(async()=>{ with(top.window){ ${t.join("\n")} } })();`,o=document.createElement("iframe");o.style.display="none",o.id=e,a.appendChild(o),o.contentDocument.body.appendChild(o.contentDocument.createRange().createContextualFragment(`<script>${n}<\/script>`))}(n),"every_js"===e&&(window.js_every_EXECUUTE=n)}t.swap&&u(a),t?.css?.constant&&t.css.constant.forEach((t=>{s(t,"constant")})),c(),i(),await async function(){if(t.constant){const n=t.constant.map((async t=>{const n=window.location.pathname;let o;o=t.except?.[n]?await d(t.except[n]):await d(t.path);const c=(await e.createContextualFragment(o)).querySelector(t.selector);if(!c)return void console.error(`Constant selector "${t.selector}" is missing in constant path "${t.path}"`);await u(c);const i=a.querySelector(t.selector);i?i.replaceWith(c):alert(`<${t.selector}> element not find!`)}));await Promise.all(n)}}(),await l(),await async function(){t?.js?.constant&&(f("#constant_js"),await y(t?.js?.constant))}(),await h(),await w(),await p(),old_v_page=window.location.pathname,window.addEventListener("popstate",cleanup),a.addEventListener("click",(async t=>{const e="A"===t.target.tagName?t.target:t.target.closest("a");if(!e||e.hasAttribute("target"))return;const a=new URL(e.href).protocol;"https:"!==a&&"http:"!==a||(t.preventDefault(),history.pushState({},"",e.href),await cleanup())}))})();