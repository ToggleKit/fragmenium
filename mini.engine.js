(async()=>{window.cleanup=async()=>{old_v_page||(old_v_page=window.location.pathname),n(),o(),await i(),await s(),await w(),await r(),await l(),window.scrollTo({top:0,behavior:"smooth"})};const t=await import("./reference.js").then((t=>t.ref)),e=document.createRange(),a=document.body;function n(){if(!t?.css?.common)return;let e=new f(window.location.pathname).directory_path();""===e&&(e="/");const a=t.css.common[e];window.active_dir!==e&&(document.head.querySelectorAll('link[data-type="common"]').forEach((t=>t.remove())),window.active_dir=e,a&&a.forEach((t=>c(t,"common"))))}function o(){if(!t?.css?.specifics)return;document.head.querySelectorAll('link[data-type="specific"]').forEach((t=>t.remove()));const e=t.css.specifics[window.location.pathname];e&&e.forEach((t=>c(t,"specific")))}function c(t,a){document.head.appendChild(e.createContextualFragment(`<link data-type="${a}" rel="stylesheet" href="${t}">`))}async function i(a){if(t.unique){const a=window.location.pathname,n=await fetch(a);if(!n.ok){const e=t.error_page?t.error_page:"/404.html";return history.replaceState({},"",e),void i()}const o=await n.text(),c=await e.createContextualFragment(o),s=t.unique.map((async t=>{const e=document.querySelector(t),n=c.querySelector(t);await p(n),e?n?e.replaceWith(n):console.log(`"${t}" does not exist in ${a}`):console.log(`"${t}" does not exist in ${old_v_page}`)}));await Promise.all(s)}}async function s(){if(t.common){let n=new f(window.location.pathname).directory_path();""===n&&(n="/");const o=t.common.map((async t=>{let o;if(t.except&&(o=t.except[n]),o){if(window[t.selector]==n)return;window[t.selector]=n}else{if("default"==window[t.selector])return;window[t.selector]="default",o=t.default}const c=a.querySelector(t.selector);if(c)try{const a=await u(o),n=e.createContextualFragment(a).querySelector(t.selector);await p(n),c.replaceWith(n)}catch(e){console.error(`Error fetching or injecting ${t.path}:`,e)}else console.log(`"${t.selector}" does not exist on this page`)}));await Promise.all(o)}}async function r(){if(!t?.js?.common)return;h("#common_js");let e=new f(window.location.pathname).directory_path();""==e&&(e="/");t.js.common[e]&&await d(t.js.common[e],"common_js")}async function l(){if(!t?.js?.specific)return;h("#specific_js");const e=window.location.pathname,a=t.js.specific[e];a&&await d(a,"specific_js")}async function w(){t?.js?.every&&(h("#every_js"),await d(t.js.every,"every_js"))}async function p(a){if(!t.swap)return;const n=Object.entries(t.swap).map((async([t,n])=>{const o=a.querySelectorAll(t);for(const t of o)if(t){let a;window["swap_text_"+n]?a=window["swap_text_"+n]:(a=await u(n),window["swap_text_"+n]=a);const o=a.match(/\${(.*?)}/g);if(o)for(let e of o){const n=t.getAttribute(e.match(/\$\{([^}]+)\}/)?.[1])??"";a=a.replace(e,n)}const c=e.createContextualFragment(a);t.replaceWith(c)}}));await Promise.all(n)}async function u(e){if("dev"!==t.version){const a="Fragmenium",n=new Request("/fragment-version"),o=await caches.open(a),c=await o.match(n);if((c?await c.text():null)!==t.version){await caches.delete(a);const o=await caches.open(a);await o.put(n,new Response(t.version,{headers:{"Content-Type":"text/plain; charset=utf-8"}}));const c=await fetch(e);if(!c.ok)throw new Error(`HTTP ${c.status}`);return await o.put(e,c.clone()),await c.text()}const i=await o.match(e);if(i)return await i.text();const s=await fetch(e);if(!s.ok)throw new Error(`HTTP ${s.status}`);return await o.put(e,s.clone()),await s.text()}{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}`);return await t.text()}}function h(t){document.querySelector(t)?.remove()}function f(t){this.path=t,this.extention=()=>this.path.split(".").pop(),this.file=()=>this.path.split("/").pop(),this.directory_path=()=>{const t=this.path.split("/");return t.pop(),t.join("/")},this.directorys=()=>{const t=this.path.split("/");return t.shift(),t.pop(),t}}async function d(t,e){const n=await Promise.all(t.map((async t=>`\n //start ${t}\n${await u(t)}\n//end ${t}\n`)));!function(t){const n=`(async()=>{ with(top.window){ ${t.join("\n")} } })();`,o=document.createElement("iframe");o.style.display="none",o.id=e,a.appendChild(o),o.contentDocument.body.appendChild(o.contentDocument.createRange().createContextualFragment(`<script>${n}<\/script>`))}(n),"every_js"===e&&(window.js_every_EXECUUTE=n)}t.swap&&p(a),t?.css?.constant&&t.css.constant.forEach((t=>{c(t,"constant")})),n(),o(),await async function(){if(t.constant){const n=t.constant.map((async t=>{const n=window.location.pathname;let o;o=t.except?.[n]?await u(t.except[n]):await u(t.path);const c=(await e.createContextualFragment(o)).querySelector(t.selector);if(!c)return void console.error(`Constant selector "${t.selector}" is missing in constant path "${t.path}"`);await p(c);const i=a.querySelector(t.selector);i?i.replaceWith(c):alert(`<${t.selector}> element not find!`)}));await Promise.all(n)}}(),await s(),await async function(){t?.js?.constant&&(h("#constant_js"),await d(t?.js?.constant))}(),await w(),await r(),await l(),old_v_page=window.location.pathname,window.addEventListener("popstate",cleanup),a.addEventListener("click",(async t=>{const e="A"===t.target.tagName?t.target:t.target.closest("a");if(!e||e.hasAttribute("target"))return;const a=new URL(e.href).protocol;"https:"!==a&&"http:"!==a||(t.preventDefault(),history.pushState({},"",e.href),await cleanup())}))})();